<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../css-2/dashboard.css">
    <title>Mentor Dashboard</title>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">PROTRACK</div>
        <div class="nav-links">
            <a href="#" class="nav-item active">Project Dashboard</a>
            <a href="add-project.html" class="nav-item">Add Project</a>
            <a href="#" class="nav-item">Schedule</a>
            <a href="#" class="nav-item">Course Recommendations</a>
        </div>
        <div class="sidebar-footer">
            <a href="#" class="nav-item">Settings</a>
            <a href="/" class="nav-item">Logout</a>
        </div>
    </nav>

   
<main class="main-content">
        <div class="main-area">
    <div class="top-bar">
        <h1>Mentoring Overview</h1>
        <div class="profile-circle">M</div>
    </div>

    <h2>Active Projects</h2>
    <div id="activeProjectsList" class="project-grid">
        </div>
</div>
</main>
<div id="projectInfoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 id="infoProjectName">Project Details</h3>
        <hr>
        <p id="infoProjectDescription"></p>
        <div class="modal-actions">
            <button onclick="closeInfoModal()" class="cancel-btn">Close</button>
        </div>
    </div>
</div>

<script>
    // FIX 1: Declare projects globally
    let projects = [];

    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('activeProjectsList');
        
        try {
            const res = await fetch('/api/projects/mentor/active');
            // FIX 2: Assign to the global variable (remove 'const')
            projects = await res.json();

            if (projects.length === 0) {
                container.innerHTML = `<p style="color: #bbb; text-align: center; grid-column: 1/-1;">No active projects found.</p>`;
                return;
            }

            container.innerHTML = projects.map(p => {
                const needsMoreStudents = p.students.length < p.requiredStudents;
                const slotsLeft = p.requiredStudents - p.students.length;
                const isCompleted = p.status === 'Completed';

                return `
        <div class="project-card ${isCompleted ? 'card-completed' : ''}"
         onclick="if(!event.target.closest('.add-btn') && !event.target.closest('.info-icon')) location.href='project-view.html?id=${p._id}'" 
         style="cursor: pointer; position: relative;">
        
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h3 style="margin: 0; flex: 1; padding-right: 10px;">${p.projectName}
                ${isCompleted ? '<span class="complete-checkmark" title="Project Verified">✅</span>' : ''}
                </h3>
            
            <div class="button-group">
                ${needsMoreStudents ? 
                    `<button class="add-btn" 
                             onclick="event.stopPropagation(); openAddStudentModal('${p._id}')" 
                             title="Add Student">+</button>` 
                    : ''}
                
                <span class="info-icon" 
                      onclick="event.stopPropagation(); openProjectInfo('${p._id}')" 
                      title="View Info">ℹ️</span>
            </div>
        </div>

        <p><strong>Domain:</strong> ${p.domain}</p>
        <p><strong>Students:</strong> ${p.students.length > 0 ? p.students.join(', ') : 'None assigned'}</p>
        
        <div class="slot-info" style="margin-top: 10px; font-size: 0.9rem;">
            ${needsMoreStudents ? 
                `<span style="color: #ff9800;">${slotsLeft} slot(s) remaining</span>` 
                : `<span style="color: #4caf50;">Project Full</span>`}
        </div>
        <div style="margin-top: 5px; font-size: 0.8rem; color: #aaa;">Status: ${p.status}</div>
            </div>
        `;
            }).join('');
        } catch (err) {
            console.error("Error loading active projects:", err);
            container.innerHTML = `<p style="color: red;">Error loading projects.</p>`;
        }

        if (projectData.status === 'Completed') {
        updateUItoCompleted(projectData.rating);
        }
    });

    // --- POPUP LOGIC ---
    function openProjectInfo(projectId) {
        // Now 'projects' is accessible globally
        const project = projects.find(p => p._id === projectId);

        if (project) {
            document.getElementById('infoProjectName').innerText = project.projectName;
            document.getElementById('infoProjectDescription').innerText = 
                project.description || "No description provided for this project.";
            
            // Flex makes the overlay center the content
            document.getElementById('projectInfoModal').style.display = 'flex';
        }
    }

    function closeInfoModal() {
        document.getElementById('projectInfoModal').style.display = 'none';
    }
    
    // Add Student Function
    async function openAddStudentModal(projectId) {
        const studentId = prompt("Enter the Student Roll Number to add:");
        if (!studentId) return;

        try {
            const response = await fetch('/api/projects/add-student', {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}` 
                },
                body: JSON.stringify({ projectId, studentId })
            });

            const data = await response.json();
            if (response.ok) {
                alert("Student added successfully!");
                location.reload();
            } else {
                alert(data.error || "Failed to add student");
            }
        } catch (err) {
            console.error("Error updating project:", err);
        }
    }
</script>