<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../css-2/dashboard.css">
    <link rel="stylesheet" href="../css-2/modals.css">
    <link rel="stylesheet" href="../css-2/notify.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../js/utils.js"></script>

    <title>Mentor Dashboard</title>
</head>
<body>
    
    <!-- <a href="add-project.html" class="nav-item">Add Project</a> -->
   <nav class="sidebar">
        <div class="sidebar-header">PROTRACK</div>
        <div class="nav-links">
            <a href="#" class="nav-item active">
                <i class="fas fa-th-large"></i> Dashboard
            </a>

            <a href="add-project.html" class="nav-item">
                <i class="fas fa-plus-circle"></i> Add Project
            </a>

            <a href="#" class="nav-item">
                <i class="fas fa-calendar-alt"></i> Schedule
            </a>

            <a href="#" class="nav-item">
                <i class="fas fa-book"></i> Courses
            </a>
        </div>

        <div class="sidebar-footer">
           <a href="./settings.html" class="nav-item">
           <i class="fas fa-cog icon-settings"></i> Settings
            </a>
            
            <a href="login.html" class="nav-item" onclick="localStorage.clear()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>

   
<main class="main-content">
        <div class="main-area">
    <div class="top-bar">
    <h1>Mentoring Overview</h1>
    
    <div class="top-bar-right"> 
        <div class="notification-container">
            <button id="notiBtn" class="notification-btn" onclick="toggleNotifications()">
                <i class="fas fa-bell"></i>
                <span class="noti-badge" style="display: none;">0</span>
            </button>
            
            <div id="notiDropdown" class="notification-dropdown">
                <div class="noti-header">
                    <span>Notifications</span>
                    <button class="mark-all-read-btn" onclick="markAllAsRead()">Mark all as read</button>
                </div>
                <div id="notiList" class="noti-list"></div>
            </div>
        </div>
        <a href="profile.html"><div class="profile-circle">M</div></a>
        
    </div>
</div>

    <h2>Active Projects</h2>
    <div id="activeProjectsList" class="project-grid">
        </div>
</div>
</main>
<div id="projectInfoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 id="infoProjectName">Project Details</h3>
        <hr>
        <p id="infoProjectDescription"></p>
        <div class="modal-actions">
            <button onclick="closeInfoModal()" class="cancel-btn">Close</button>
        </div>
    </div>
</div>

<script>
    // FIX 1: Declare projects globally
    let projects = [];

    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('activeProjectsList');
        
        try {
            const res = await fetch('/api/projects/mentor/active');
            // FIX 2: Assign to the global variable (remove 'const')
            projects = await res.json();

            if (projects.length === 0) {
                container.innerHTML = `<p style="color: #bbb; text-align: center; grid-column: 1/-1;">No active projects found.</p>`;
                return;
            }

            container.innerHTML = projects.map(p => {
                const needsMoreStudents = p.students.length < p.requiredStudents;
                const slotsLeft = p.requiredStudents - p.students.length;
                const isCompleted = p.status === 'Completed';

                return `
        <div class="project-card ${isCompleted ? 'card-completed' : ''}"
         onclick="if(!event.target.closest('.add-btn') && !event.target.closest('.info-icon')) location.href='project-view.html?id=${p._id}'" 
         style="cursor: pointer; position: relative;">
        
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h3 style="margin: 0; flex: 1; padding-right: 10px;">${p.projectName}
                ${isCompleted ? '<span class="complete-checkmark" title="Project Verified">✅</span>' : ''}
                </h3>
            
            <div class="button-group">
                ${needsMoreStudents ? 
                    `<button class="add-btn" 
                             onclick="event.stopPropagation(); openAddStudentModal('${p._id}')" 
                             title="Add Student">+</button>` 
                    : ''}
                
                <span class="info-icon" 
                      onclick="event.stopPropagation(); openProjectInfo('${p._id}')" 
                      title="View Info">ℹ️</span>
            </div>
        </div>

        <p><strong>Domain:</strong> ${p.domain}</p>
        <p><strong>Students:</strong> ${p.students.length > 0 ? p.students.join(', ') : 'None assigned'}</p>
        
        <div class="slot-info" style="margin-top: 10px; font-size: 0.9rem;">
            ${needsMoreStudents ? 
                `<span style="color: #ff9800;">${slotsLeft} slot(s) remaining</span>` 
                : `<span style="color: #4caf50;">Project Full</span>`}
        </div>
        <div style="margin-top: 5px; font-size: 0.8rem; color: #aaa;">Status: ${p.status}</div>
            </div>
        `;
            }).join('');
        } catch (err) {
            console.error("Error loading active projects:", err);
            container.innerHTML = `<p style="color: red;">Error loading projects.</p>`;
        }

        if (projectData.status === 'Completed') {
        updateUItoCompleted(projectData.rating);
        }
        const name = localStorage.getItem("userName");
        if (name) {
            document.getElementById("profileInitial").innerText =
                name.charAt(0).toUpperCase();
        }
    });

    // --- POPUP LOGIC ---
    function openProjectInfo(projectId) {
        // Now 'projects' is accessible globally
        const project = projects.find(p => p._id === projectId);

        if (project) {
            document.getElementById('infoProjectName').innerText = project.projectName;
            document.getElementById('infoProjectDescription').innerText = 
                project.description || "No description provided for this project.";
            
            // Flex makes the overlay center the content
            document.getElementById('projectInfoModal').style.display = 'flex';
        }
    }

    function closeInfoModal() {
        document.getElementById('projectInfoModal').style.display = 'none';
    }
    
    // Add Student Function
    async function openAddStudentModal(projectId) {
        const studentId = await showPrompt("Enter the Student Roll Number to add:");
        if (!studentId) return;

        try {
            const response = await fetch('/api/projects/add-student', {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}` 
                },
                body: JSON.stringify({ projectId, studentId })
            });

            const data = await response.json();
            if (response.ok) {
                showAlert("Student added successfully!", "success", false);
                location.reload();
            } else {
                showAlert(data.error || "Failed to add student", "error", false);
            }
        } catch (err) {
            console.error("Error updating project:", err);
        }
    }
    function goToProfile() {
        window.location.href = "profile.html";
    }

   
</script>
<div id="common-alert" class="protrack-alert">
    <i id="alert-icon" class="fas"></i>
    <span id="alert-text"></span>
    </div>
    <div id="custom-prompt" class="modal-overlay" style="display: none;">
        <div class="modal-content protrack-glass">
            <h3 id="prompt-title">Input Required</h3>
            <p id="prompt-message"></p>
            <input type="text" id="prompt-input" class="protrack-input" autocomplete="off">
            <div class="modal-actions">
                <button id="prompt-confirm" class="confirm-btn">Confirm</button>
                <button id="prompt-cancel" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>
<script src="../js/notificationHandler.js"></script>
<script src="../js/profile.js"></script>


</body>
</html>